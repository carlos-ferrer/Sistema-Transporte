<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteiro de Viagens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .autocomplete-suggestions { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; position: absolute; width: 100%; z-index: 10; background-color: white; border-radius: 0 0 0.5rem 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .autocomplete-suggestion { padding: 10px; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f0f0f0; }
        .modal { transition: opacity 0.25s ease; }
        @media print {
            body * { visibility: hidden; }
            #print-iframe, #print-iframe * { visibility: visible; }
            #print-iframe { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen bg-gray-200 font-sans">
    <div id="sidebar" class="h-full p-4 bg-white shadow-lg w-64 fixed lg:static -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20">
        <div class="flex items-center border-b pb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <h1 class="text-xl font-bold text-gray-800 ml-3">TFD Paraguaçu</h1>
        </div>
        <nav class="mt-6">
             <a href="index.html" class="flex items-center py-2 px-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="mx-3">Início</span>
            </a>
            <a href="cadastro_viagem.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span class="mx-3">Cadastro de Viagem</span>
            </a>
            <a href="roteiro.html" class="flex items-center py-2 px-4 mt-4 text-gray-700 bg-gray-100 rounded-lg border-r-4 border-blue-500">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3"></path></svg>
                <span class="mx-3 font-semibold">Roteiro de Viagens</span>
            </a>
            <a href="solicitacoes_pendentes.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="mx-3">Solicitações Pendentes</span>
            </a>
             <a href="relatorios.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="mx-3">Relatórios</span>
            </a>
        </nav>
    </div>
    <div class="flex-1 flex flex-col">
        <header class="bg-white shadow flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">Roteiro de Viagens</h1>
            <button id="menu-button" class="text-gray-500 focus:outline-none lg:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6 lg:p-8">
            <div class="w-full bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Viagens Criadas</h2>
                    <a href="criar_roteiro.html" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 text-center">
                        + Novo Roteiro
                    </a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <input type="text" id="filter-date" class="p-2 border rounded-lg bg-white" placeholder="Filtrar por data">
                    <div class="relative">
                       <input type="text" id="filter-vehicle" placeholder="Filtrar por veículo..." class="w-full p-2 border rounded-lg" autocomplete="off">
                       <div id="vehicle-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                    <div class="relative">
                       <input type="text" id="filter-destination" placeholder="Filtrar por destino..." class="w-full p-2 border rounded-lg" autocomplete="off">
                       <div id="destination-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                    <div class="relative">
                        <input type="text" id="filter-driver" placeholder="Filtrar por motorista..." class="w-full p-2 border rounded-lg" autocomplete="off">
                        <div id="driver-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                </div>
                <div id="itineraries-list" class="space-y-4">
                    <p class="text-center text-gray-500 py-4">A carregar roteiros...</p>
                </div>
            </div>
        </main>
    </div>
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black opacity-50 z-10 lg:hidden"></div>
</div>

<div id="view-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" id="view-modal-content">
    </div>
</div>

<div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h3>
        <p class="text-gray-600 mb-6">Tem a certeza de que deseja excluir este roteiro? Os pacientes voltarão para a lista de pendentes.</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
            <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Excluir</button>
        </div>
    </div>
</div>

<iframe id="print-iframe" style="display:none;"></iframe>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        const menuButton = document.getElementById('menu-button'), sidebar = document.getElementById('sidebar'), overlay = document.getElementById('sidebar-overlay');
        const itinerariesListDiv = document.getElementById('itineraries-list');
        const filterDate = document.getElementById('filter-date'), filterVehicle = document.getElementById('filter-vehicle'), filterDestination = document.getElementById('filter-destination'), filterDriver = document.getElementById('filter-driver');
        const viewModal = document.getElementById('view-modal'), viewModalContent = document.getElementById('view-modal-content');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal'), cancelDeleteBtn = document.getElementById('cancel-delete-btn'), confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const printIframe = document.getElementById('print-iframe');

        const CITIES = ["Adamantina - SP", "Alto Garças - MT", "Álvares Machado - SP", "Araçatuba - SP", "Assis - SP", "Avaré - SP", "Barretos - SP", "Bauru - SP", "Botucatu - SP", "Campinas - SP", "Cândido Mota - SP", "Chavantes - SP", "Fernandópolis - SP", "Franca - SP", "Garça - SP", "Herculândia - SP", "Ilha Solteira - SP", "Jales - SP", "Jaú - SP", "Jundiaí - SP", "Londrina - PR", "Marialva - PR", "Marília - SP", "Osvaldo Cruz - SP", "Ourinhos - SP", "Palmital - SP", "Paraguaçu Paulista - SP", "Pardinho - SP", "Penápolis - SP", "Pirapozinho - SP", "Presidente Prudente - SP", "Presidente Venceslau - SP", "Rancharia - SP", "Ribeirão Preto - SP", "Rosana - SP", "Salto - SP", "Santa Cruz do Rio Pardo - SP", "Santos - SP", "São José do Rio Preto - SP", "São Paulo - SP", "Sorocaba - SP", "Tarumã - SP", "Taubaté - SP", "Tupã - SP", "Valinhos - SP"];
        const DRIVERS = ["A definir", "Ademir Pacheco 1", "Ademir Pacheco 2", "Ademir Pacheco 3", "Adilson Adolfo Itelvino 1", "Adilson Adolfo Itelvino 2", "Adilson Adolfo Itelvino 3", "Adriano Aparecido Paschoa 1", "Adriano Aparecido Paschoa 2", "Adriano Aparecido Paschoa 3", "Almir Rogerio da Silva 1", "Almir Rogerio da Silva 2", "Almir Rogerio da Silva 3", "Carlos Antonio Rocha 1", "Carlos Antonio Rocha 2", "Carlos Antonio Rocha 3", "Claudio Rodrigues Santana 1", "Claudio Rodrigues Santana 2", "Claudio Rodrigues Santana 3", "Daniel Ricardo Pontes 1", "Daniel Ricardo Pontes 2", "Daniel Ricardo Pontes 3", "Jefferson Sales Prado 1", "Jefferson Sales Prado 2", "Jefferson Sales Prado 3", "Leandro Muniz Balbino 1", "Leandro Muniz Balbino 2", "Leandro Muniz Balbino 3", "Marcelo Dias Paiao 1", "Marcelo Dias Paiao 2", "Marcelo Dias Paiao 3", "Marcio Antonio dos Reis 1", "Marcio Antonio dos Reis 2", "Marcio Antonio dos Reis 3", "Marcos Aurelio de Oliveira 1", "Marcos Aurelio de Oliveira 2", "Marcos Aurelio de Oliveira 3", "Paulo Cesar Rosa de Barros 1", "Paulo Cesar Rosa de Barros 2", "Paulo Cesar Rosa de Barros 3", "Samara Batista da Silva 1", "Samara Batista da Silva 2", "Samara Batista da Silva 3", "Sebastiao Aparecido Pereira 1", "Sebastiao Aparecido Pereira 2", "Sebastiao Aparecido Pereira 3", "Silvio Andrade Garcia 1", "Silvio Andrade Garcia 2", "Silvio Andrade Garcia 3", "Valmir de Paula Ribeiro 1", "Valmir de Paula Ribeiro 2", "Valmir de Paula Ribeiro 3"];
        const FROTA_VEHICLES = ["Frota 306 - BNZ-3793", "Frota 318 - EGI-6209", "Frota 372 - FRU-2815", "Frota 392 - GCH-7877", "Frota 396 - FTS-1237", "Frota 397 - FOE-7011", "Frota 418 - GBX-4239", "Frota 419 - GDY-7265", "Frota 426 - FXQ-5064", "Frota 428 - GEB-8322", "Frota 429 - GBT-5687", "Frota 435 - ESM-7966", "Frota 439 - ERD-0542", "Frota 448 - FSM-6673", "Frota 454 - FUK-8A34", "Frota 455 - FSA-8F66", "Frota 462 - CNR-6C51", "Frota 463 - EOJ-9C01", "Frota 467 - GBO-8C25", "Frota 470 - EWZ-1C33", "Frota 480 - FUH-5H54", "Frota 481 - FWO-6F86", "Frota 482 - FNT-3C46", "Frota 483 - FYO-1F74", "Frota 494 - FRC-9172", "Frota 495 - FUH-5J32", "Frota 498 - FST-1A72", "Frota 503 - FJF-5A63", "Frota 515 - GDY-4A91", "Frota 516 - FXC-3E81", "Frota 537 - STU-1J61", "Frota 538 - STJ-2G66", "Frota 547 - FQY-0I61", "Frota 548 - SUM-0E46", "Frota 555 - FCQ-2H31", "Frota 556 - EXF-1H41", "Frota 557 - TJM-3B92", "Frota 558 - TLA-0E43", "Frota 569 - TKE-9F75"];
        const ALL_VEHICLES = [
            ...FROTA_VEHICLES,
            ...Array.from({ length: 5 }, (_, i) => `A definir - Ambulância ${i + 1}`),
            ...Array.from({ length: 10 }, (_, i) => `A definir - Exclusivo ${i + 1}`),
            ...Array.from({ length: 25 }, (_, i) => `A definir - Coletivo ${i + 1}`),
            ...Array.from({ length: 3 }, (_, i) => `A definir - Hemodiálise ${i + 1}`)
        ];

        let allItineraries = [];
        let allRequests = [];
        let itineraryToDeleteId = null;
        let db;
        let appId;

        const toggleMenu = () => {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        };

        flatpickr(filterDate, {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d \\de F \\de Y",
            locale: "pt",
            onChange: function(selectedDates, dateStr, instance) {
                renderItineraries();
            }
        });
        
        function setupAutocomplete(input, suggestionsDiv, data) {
            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                suggestionsDiv.innerHTML = '';
                if (!query) {
                    suggestionsDiv.classList.add('hidden');
                    renderItineraries();
                    return;
                }
                const filtered = data.filter(item => item.toLowerCase().includes(query));
                if (filtered.length > 0) {
                    suggestionsDiv.classList.remove('hidden');
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item;
                        div.className = 'autocomplete-suggestion';
                        div.addEventListener('click', () => {
                            input.value = item;
                            suggestionsDiv.classList.add('hidden');
                            renderItineraries();
                        });
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
                renderItineraries();
            });
            document.addEventListener('click', (e) => {
                if (e.target !== input) {
                    suggestionsDiv.classList.add('hidden');
                }
            });
        }
        
        function renderItineraries() {
            const date = filterDate.value;
            const vehicle = filterVehicle.value.toLowerCase();
            const destination = filterDestination.value.toLowerCase();
            const driver = filterDriver.value.toLowerCase();

            const filteredItineraries = allItineraries.filter(itinerary => {
                const hasDate = !date || itinerary.date === date;
                const hasVehicle = !vehicle || itinerary.vehicle.toLowerCase().includes(vehicle);
                const hasDriver = !driver || itinerary.driver.toLowerCase().includes(driver);
                const hasDestination = !destination || itinerary.destinations.some(d => d.toLowerCase().includes(destination));
                return hasDate && hasVehicle && hasDriver && hasDestination;
            });
            
            itinerariesListDiv.innerHTML = '';
            if (filteredItineraries.length === 0) {
                itinerariesListDiv.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum roteiro encontrado para os filtros selecionados.</p>';
                return;
            }

            filteredItineraries.forEach(itinerary => {
                const card = document.createElement('div');
                card.className = 'bg-white border rounded-lg p-4 flex flex-col md:flex-row justify-between items-center';
                const formattedDate = new Date(itinerary.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
                card.innerHTML = `
                    <div class="flex-1 mb-4 md:mb-0">
                        <p class="text-xl font-bold text-blue-600">${formattedDate} - ${itinerary.time}</p>
                        <p class="text-gray-700"><strong>Tipo de Transporte:</strong> ${itinerary.transportType}</p>
                        <p class="text-gray-700"><strong>Motorista:</strong> ${itinerary.driver}</p>
                        <p class="text-gray-700"><strong>Veículo:</strong> ${itinerary.vehicle}</p>
                        <p class="text-gray-600"><strong>Destinos:</strong> ${itinerary.destinations.join(', ')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-id="${itinerary.id}" class="view-btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg">Visualizar</button>
                        <a href="editar_roteiro.html?id=${itinerary.id}" class="bg-yellow-500 text-white hover:bg-yellow-600 font-semibold py-2 px-4 rounded-lg">Editar</a>
                        <button data-id="${itinerary.id}" class="delete-btn bg-red-600 text-white hover:bg-red-700 font-semibold py-2 px-4 rounded-lg">Excluir</button>
                        <button data-id="${itinerary.id}" class="print-btn bg-green-600 text-white hover:bg-green-700 font-semibold py-2 px-4 rounded-lg">Imprimir</button>
                    </div>
                `;
                itinerariesListDiv.appendChild(card);
            });
        }
        
        function openModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        function closeModal(modal) {
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        async function showViewModal(itineraryId) {
            const itinerary = allItineraries.find(i => i.id === itineraryId);
            if (!itinerary) return;
            const patients = allRequests.filter(r => itinerary.patientIds.includes(r.id));
            
            const formattedDate = new Date(itinerary.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

            viewModalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start border-b pb-4 mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">Detalhes do Roteiro</h3>
                            <p class="text-gray-600">${formattedDate} às ${itinerary.time}</p>
                        </div>
                        <button id="close-view-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <p><strong>Motorista:</strong> ${itinerary.driver}</p>
                        <p><strong>Veículo:</strong> ${itinerary.vehicle}</p>
                        <p><strong>Tipo de Transporte:</strong> ${itinerary.transportType}</p>
                        <div>
                            <h4 class="font-semibold text-lg mb-2">Pacientes (${patients.length})</h4>
                            <ul class="list-disc list-inside space-y-2 max-h-60 overflow-y-auto pr-2">
                                ${patients.map(p => `
                                    <li>
                                        <strong>${p.patientName}</strong> - ${p.appointmentTime} - ${p.city} (${p.location})
                                        ${p.companions.length > 0 ? `<br><small class="text-gray-500 pl-4">Acompanhantes: ${p.companions.join(', ')}</small>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>`;
            openModal(viewModal);
        }

        function createPrintContent(itineraryId) {
            const itinerary = allItineraries.find(i => i.id === itineraryId);
            if (!itinerary) return null;
            const patientsInItinerary = allRequests.filter(req => itinerary.patientIds.includes(req.id));
            const formattedDate = new Date(itinerary.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

            let patientRows = patientsInItinerary.map(p => `
                <tr>
                    <td style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">${p.patientName}</td>
                    <td style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">${p.appointmentTime}</td>
                    <td style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">${p.city} (${p.location})</td>
                    <td style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">${p.boardingLocation}</td>
                    <td style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">${p.companions.length > 0 ? p.companions.join(', ') : 'Nenhum'}</td>
                    <td style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">${p.observations || 'Nenhuma'}</td>
                </tr>
            `).join('');

            return `
                <div style="padding: 1.5rem; color: #000; font-family: 'Times New Roman', Times, serif;">
                    <header style="display: flex; align-items: center; border-bottom: 1px solid #000; padding-bottom: 15px; margin-bottom: 15px;">
                        <img src="Brasão_de_Paraguaçu_Pta.jpg" alt="Brasão de Paraguaçu Paulista" style="width: 80px; height: auto; margin-right: 15px;">
                        <div style="text-align: center; width: 100%;">
                            <h1 style="font-size: 16px; font-weight: bold; margin: 0;">SECRETARIA MUNICIPAL DE SAÚDE</h1>
                            <h2 style="font-size: 14px; font-weight: bold; margin: 0;">PARAGUAÇU PAULISTA</h2>
                        </div>
                    </header>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="font-size: 14px; font-weight: bold; text-decoration: underline; margin: 0;">ROTEIRO DE VIAGEM</h3>
                    </div>
                    
                    <div style="border: 1px solid #000; padding: 10px; margin-bottom: 20px; font-size: 13px;">
                        <p style="margin: 2px 0;"><strong>Data da Viagem:</strong> ${formattedDate}</p>
                        <p style="margin: 2px 0;"><strong>Hora de Saída:</strong> ${itinerary.time}</p>
                        <p style="margin: 2px 0;"><strong>Veículo:</strong> ${itinerary.vehicle}</p>
                        <p style="margin: 2px 0;"><strong>Motorista:</strong> ${itinerary.driver}</p>
                        <p style="margin: 2px 0;"><strong>Tipo de Transporte:</strong> ${itinerary.transportType}</p>
                    </div>

                    <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">LISTA DE PACIENTES</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f2f2f2; text-align: left;">
                                <th style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">Paciente</th>
                                <th style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">Hora Consulta</th>
                                <th style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">Destino</th>
                                <th style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">Embarque</th>
                                <th style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">Acompanhantes</th>
                                <th style="border: 1px solid #ccc; padding: 6px; font-size: 12px;">Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${patientRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function showPrintView(itineraryId) {
            const printContent = createPrintContent(itineraryId);
            if (!printContent) {
                alert("Roteiro não encontrado ou sem pacientes para imprimir.");
                return;
            }

            const iframe = printIframe;
            const doc = iframe.contentWindow.document;

            doc.open();
            doc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Roteiro de Viagem</title>
                </head>
                <body style="margin: 0;">
                    ${printContent}
                </body>
                </html>
            `);
            doc.close();

            iframe.onload = function() {
                setTimeout(function() { // Adiciona um pequeno delay para garantir a renderização
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                }, 500);
            };
        }

        async function deleteItinerary() {
            if (!itineraryToDeleteId) return;
            const itinerary = allItineraries.find(i => i.id === itineraryToDeleteId);
            
            try {
                const batch = writeBatch(db);
                batch.delete(doc(db, `artifacts/${appId}/public/data/itineraries`, itineraryToDeleteId));
                itinerary.patientIds.forEach(patientId => {
                    batch.update(doc(db, `artifacts/${appId}/public/data/travelRequests`, patientId), { status: "Pendente" });
                });
                await batch.commit();
            } catch (error) {
                console.error("Erro ao excluir roteiro: ", error);
                alert("Ocorreu um erro ao excluir o roteiro.");
            } finally {
                closeModal(deleteConfirmModal);
                itineraryToDeleteId = null;
            }
        }
        
        if(menuButton) menuButton.addEventListener('click', toggleMenu);
        if(overlay) overlay.addEventListener('click', toggleMenu);
        
        [filterDate, filterVehicle, filterDestination, filterDriver].forEach(el => {
            el.addEventListener('input', renderItineraries);
        });
        
        itinerariesListDiv.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const printBtn = e.target.closest('.print-btn');
            
            if (viewBtn) showViewModal(viewBtn.dataset.id);
            if (deleteBtn) {
                itineraryToDeleteId = deleteBtn.dataset.id;
                openModal(deleteConfirmModal);
            }
            if (printBtn) showPrintView(printBtn.dataset.id);
        });

        viewModal.addEventListener('click', (e) => { 
            if (e.target === viewModal || e.target.closest('#close-view-modal-btn')) closeModal(viewModal); 
        });
        cancelDeleteBtn.addEventListener('click', () => { closeModal(deleteConfirmModal); itineraryToDeleteId = null; });
        confirmDeleteBtn.addEventListener('click', deleteItinerary);

        async function initializeFirebase() {
            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'tfd-paraguacu-paulista-local';
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {
                        apiKey: "AIzaSyAWWhu2U6ZJ9AQYZ_Awa2CnciewwY2x71E",
                        authDomain: "tfd-transporte.firebaseapp.com",
                        projectId: "tfd-transporte",
                        storageBucket: "tfd-transporte.appspot.com",
                        messagingSenderId: "747365724187",
                        appId: "1:747365724187:web:4056286c794834f69f48be"
                      };
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                const itinerariesCollection = collection(db, `artifacts/${appId}/public/data/itineraries`);
                const requestsCollection = collection(db, `artifacts/${appId}/public/data/travelRequests`);

                onSnapshot(itinerariesCollection, (snapshot) => {
                    allItineraries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allItineraries.sort((a, b) => new Date(b.date) - new Date(a.date));
                    renderItineraries();
                }, (error) => {
                    console.error("Erro ao carregar roteiros:", error);
                    itinerariesListDiv.innerHTML = '<p class="text-center text-red-500 py-4">Não foi possível carregar os roteiros. Verifique a ligação.</p>';
                });

                onSnapshot(requestsCollection, (snapshot) => {
                    allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }, (error) => {
                     console.error("Erro ao carregar solicitações:", error);
                });

            } catch(error) {
                console.error("Erro na inicialização do Firebase: ", error);
                 itinerariesListDiv.innerHTML = '<p class="text-center text-red-500 py-4">Erro de configuração do Firebase. Verifique a consola.</p>';
            }
        }
        
        setupAutocomplete(filterVehicle, document.getElementById('vehicle-suggestions'), ALL_VEHICLES);
        setupAutocomplete(filterDestination, document.getElementById('destination-suggestions'), CITIES);
        setupAutocomplete(filterDriver, document.getElementById('driver-suggestions'), DRIVERS);
        initializeFirebase();
    });
</script>
</body>
</html>