<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Solicitações Pendentes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen bg-gray-200 font-sans">
    <!-- Sidebar -->
    <div id="sidebar" class="h-full p-4 bg-white shadow-lg w-64 fixed lg:static -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20">
        <div class="flex items-center border-b pb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <h1 class="text-xl font-bold text-gray-800 ml-3">TFD Paraguaçu</h1>
        </div>
        <nav class="mt-6">
            <a href="index.html" class="flex items-center py-2 px-4 text-gray-600 rounded-lg hover:bg-gray-100">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="mx-3">Início</span>
            </a>
            <a href="cadastro_viagem.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span class="mx-3">Cadastro de Viagem</span>
            </a>
            <a href="roteiro.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3"></path></svg>
                <span class="mx-3">Roteiro de Viagens</span>
            </a>
            <a href="solicitacoes_pendentes.html" class="flex items-center py-2 px-4 mt-4 text-gray-700 bg-gray-100 rounded-lg border-r-4 border-blue-500">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="mx-3 font-semibold">Solicitações Pendentes</span>
            </a>
             <a href="relatorios.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="mx-3">Relatórios</span>
            </a>
        </nav>
    </div>
    <!-- Content -->
    <div class="flex-1 flex flex-col">
        <header class="bg-white shadow flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">Solicitações Pendentes</h1>
            <button id="menu-button" class="text-gray-500 focus:outline-none lg:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6 lg:p-8">
            <div class="w-full bg-white p-6 rounded-2xl shadow-lg">
                <div id="requests-list" class="space-y-4">
                    <p class="text-center text-gray-500 py-4">A carregar solicitações pendentes...</p>
                </div>
            </div>
        </main>
    </div>
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black opacity-50 z-10 lg:hidden"></div>
</div>

<!-- Modal Visualizar -->
<div id="view-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" id="view-modal-content">
        <!-- Conteúdo do Modal aqui -->
    </div>
</div>

<!-- Modal Confirmação de Exclusão -->
<div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h3>
        <p class="text-gray-600 mb-6">Tem a certeza de que deseja excluir permanentemente esta solicitação?</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
            <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Excluir</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        // --- UI ELEMENTS (RUNS FIRST) ---
        const menuButton = document.getElementById('menu-button'), sidebar = document.getElementById('sidebar'), overlay = document.getElementById('sidebar-overlay');
        const requestsListDiv = document.getElementById('requests-list');
        const viewModal = document.getElementById('view-modal'), viewModalContent = document.getElementById('view-modal-content');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal'), cancelDeleteBtn = document.getElementById('cancel-delete-btn'), confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let allRequests = [];
        let requestToDeleteId = null;
        let db;

        // --- UI FUNCTIONS ---
        const toggleMenu = () => { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); };

        function renderRequests(requests) {
            requestsListDiv.innerHTML = '';
            if (requests.length === 0) {
                requestsListDiv.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma solicitação pendente encontrada.</p>';
                return;
            }

            requests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'bg-white border rounded-lg p-4 flex flex-col md:flex-row justify-between items-center';
                const formattedDate = new Date(req.travelDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
                card.innerHTML = `
                    <div class="flex-1 mb-4 md:mb-0">
                        <p class="font-bold text-lg">${req.patientName}</p>
                        <p class="text-gray-600">${formattedDate} às ${req.appointmentTime}</p>
                        <p class="text-gray-600">${req.city} - ${req.location}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-id="${req.id}" class="view-btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg">Visualizar</button>
                        <a href="editar_solicitacao.html?id=${req.id}" class="bg-yellow-500 text-white hover:bg-yellow-600 font-semibold py-2 px-4 rounded-lg">Editar</a>
                        <button data-id="${req.id}" class="delete-btn bg-red-600 text-white hover:bg-red-700 font-semibold py-2 px-4 rounded-lg">Excluir</button>
                    </div>
                `;
                requestsListDiv.appendChild(card);
            });
        }

        function openModal(modal) { modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); }
        function closeModal(modal) { modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 250); }

        function showViewModal(requestId) {
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;

            const formattedDate = new Date(request.travelDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            
            viewModalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start border-b pb-4 mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">Detalhes da Solicitação</h3>
                        <button id="close-view-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Paciente:</strong> ${request.patientName}</p>
                        <p><strong>Data da Viagem:</strong> ${formattedDate}</p>
                        <p><strong>Hora da Consulta:</strong> ${request.appointmentTime}</p>
                        <p><strong>Cidade de Destino:</strong> ${request.city}</p>
                        <p><strong>Local:</strong> ${request.location}</p>
                        <p><strong>Tipo de Transporte:</strong> ${request.transportType}</p>
                        <p><strong>Local de Embarque:</strong> ${request.boardingLocation}</p>
                        <p><strong>Acompanhantes:</strong> ${request.companions.length > 0 ? request.companions.join(', ') : 'Nenhum'}</p>
                        <div><strong>Observações:</strong> <p class="text-sm bg-gray-50 p-2 rounded mt-1">${request.observations || 'Nenhuma'}</p></div>
                    </div>
                </div>`;
            openModal(viewModal);
        }
        
        // --- EVENT LISTENERS ---
        if(menuButton) menuButton.addEventListener('click', toggleMenu);
        if(overlay) overlay.addEventListener('click', toggleMenu);

        requestsListDiv.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (viewBtn) showViewModal(viewBtn.dataset.id);
            if (deleteBtn) {
                requestToDeleteId = deleteBtn.dataset.id;
                openModal(deleteConfirmModal);
            }
        });
        
        viewModal.addEventListener('click', (e) => { 
            if (e.target === viewModal || e.target.closest('#close-view-modal-btn')) closeModal(viewModal); 
        });

        cancelDeleteBtn.addEventListener('click', () => {
            closeModal(deleteConfirmModal);
            requestToDeleteId = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!requestToDeleteId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${window.appId}/public/data/travelRequests`, requestToDeleteId));
            } catch (error) {
                console.error("Erro ao excluir solicitação:", error);
                alert("Ocorreu um erro ao excluir a solicitação.");
            } finally {
                closeModal(deleteConfirmModal);
                requestToDeleteId = null;
            }
        });

        // --- FIREBASE INITIALIZATION & REALTIME LISTENERS ---
        async function initializeFirebase() {
            try {
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'tfd-paraguacu-paulista-local';
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {
                        apiKey: "AIzaSyAWWhu2U6ZJ9AQYZ_Awa2CnciewwY2x71E",
                        authDomain: "tfd-transporte.firebaseapp.com",
                        projectId: "tfd-transporte",
                        storageBucket: "tfd-transporte.appspot.com",
                        messagingSenderId: "747365724187",
                        appId: "1:747365724187:web:4056286c794834f69f48be"
                      };
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                const requestsCollection = collection(db, `artifacts/${window.appId}/public/data/travelRequests`);

                onSnapshot(requestsCollection, (snapshot) => {
                    allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const pendingRequests = allRequests.filter(req => req.status === 'Pendente');
                    pendingRequests.sort((a, b) => new Date(a.travelDate) - new Date(b.travelDate));
                    renderRequests(pendingRequests);
                }, (error) => {
                    console.error("Erro ao carregar solicitações:", error);
                    requestsListDiv.innerHTML = '<p class="text-center text-red-500 py-4">Não foi possível carregar as solicitações. Verifique a ligação.</p>';
                });

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                requestsListDiv.innerHTML = '<p class="text-center text-red-500 py-4">Erro de configuração do Firebase. Verifique a consola.</p>';
            }
        }
        
        initializeFirebase();
    });
</script>
</body>
</html>

