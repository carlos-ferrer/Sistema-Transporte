<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Solicitações Pendentes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen bg-gray-200 font-sans">
    <!-- Sidebar -->
    <div id="sidebar" class="h-full p-4 bg-white shadow-lg w-64 fixed lg:static -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20">
        <div class="flex items-center border-b pb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <h1 class="text-xl font-bold text-gray-800 ml-3">TFD Paraguaçu</h1>
        </div>
        <nav class="mt-6">
            <a href="index.html" class="flex items-center py-2 px-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="mx-3">Início</span>
            </a>
            <a href="cadastro_viagem.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span class="mx-3">Cadastro de Viagem</span>
            </a>
            <a href="roteiro.html" class="flex items-center py-2 px-4 mt-4 text-gray-600 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3"></path></svg>
                <span class="mx-3">Roteiro de Viagens</span>
            </a>
            <a href="solicitacoes_pendentes.html" class="flex items-center py-2 px-4 mt-4 text-gray-700 bg-gray-100 rounded-lg border-r-4 border-blue-500">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="mx-3 font-semibold">Solicitações Pendentes</span>
            </a>
        </nav>
    </div>
    <!-- Content -->
    <div class="flex-1 flex flex-col">
        <header class="bg-white shadow flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">Solicitações Pendentes</h1>
            <button id="menu-button" class="text-gray-500 focus:outline-none lg:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6 lg:p-8">
            <div class="w-full bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Lista de Solicitações</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Paciente</th>
                                <th class="py-3 px-6">Data Viagem</th>
                                <th class="py-3 px-6">Destino</th>
                                <th class="py-3 px-6">Transporte</th>
                                <th class="py-3 px-6 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="requests-table-body" class="text-gray-700 text-sm font-light">
                           <tr><td colspan="5" class="text-center py-4 text-gray-500">A carregar solicitações...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black opacity-50 z-10 lg:hidden"></div>
</div>

<!-- Modal Visualizar -->
<div id="view-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" id="view-modal-content">
        <!-- Conteúdo do Modal -->
    </div>
</div>

<!-- Modal Confirmação de Exclusão -->
<div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h3>
        <p class="text-gray-600 mb-6">Tem a certeza de que deseja excluir permanentemente esta solicitação?</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
            <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Excluir</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        // --- UI ELEMENTS (RUNS FIRST) ---
        const menuButton = document.getElementById('menu-button'), sidebar = document.getElementById('sidebar'), overlay = document.getElementById('sidebar-overlay');
        const tableBody = document.getElementById('requests-table-body');
        const viewModal = document.getElementById('view-modal'), viewModalContent = document.getElementById('view-modal-content');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal'), cancelDeleteBtn = document.getElementById('cancel-delete-btn'), confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        let allRequests = [];
        let requestIdToDelete = null;
        let db;

        // --- UI FUNCTIONS ---
        const toggleMenu = () => { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); };
        const openModal = (modal) => { modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); };
        const closeModal = (modal) => { modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 250); };

        function renderTable() {
            const pendingRequests = allRequests.filter(req => req.status === 'Pendente');
            pendingRequests.sort((a, b) => new Date(a.travelDate) - new Date(b.travelDate));
            
            tableBody.innerHTML = '';
            if (pendingRequests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma solicitação pendente encontrada.</td></tr>';
                return;
            }

            pendingRequests.forEach(req => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                const formattedDate = new Date(req.travelDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                tr.innerHTML = `
                    <td class="py-3 px-6 font-medium">${req.patientName}</td>
                    <td class="py-3 px-6">${formattedDate}</td>
                    <td class="py-3 px-6">${req.city}</td>
                    <td class="py-3 px-6">${req.transportType}</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center gap-2">
                            <button data-id="${req.id}" class="view-btn w-8 h-8 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center justify-center" title="Visualizar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </button>
                            <a href="editar_solicitacao.html?id=${req.id}" class="w-8 h-8 rounded-full bg-yellow-200 text-yellow-700 hover:bg-yellow-300 flex items-center justify-center" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </a>
                            <button data-id="${req.id}" class="delete-btn w-8 h-8 rounded-full bg-red-200 text-red-700 hover:bg-red-300 flex items-center justify-center" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        function showViewModal(requestId) {
            const req = allRequests.find(r => r.id === requestId);
            const formattedDate = new Date(req.travelDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            viewModalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start border-b pb-4 mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">Detalhes da Solicitação</h3>
                        <button id="close-view-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-3 text-gray-700">
                        <p><strong>Paciente:</strong> ${req.patientName}</p>
                        <p><strong>Data da Viagem:</strong> ${formattedDate}</p>
                        <p><strong>Hora da Consulta:</strong> ${req.appointmentTime}</p>
                        <p><strong>Destino:</strong> ${req.city} - ${req.location}</p>
                        <p><strong>Local de Embarque:</strong> ${req.boardingLocation}</p>
                        <p><strong>Tipo de Transporte:</strong> ${req.transportType}</p>
                        <p><strong>Acompanhantes:</strong> ${req.companions.length > 0 ? req.companions.join(', ') : 'Nenhum'}</p>
                        <div><strong>Observações:</strong> <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">${req.observations || 'Nenhuma'}</p></div>
                    </div>
                </div>`;
            openModal(viewModal);
        }
        
        async function deleteRequest() {
            if (!requestIdToDelete || !db) return;
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'tfd-paraguacu-paulista-local';
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/travelRequests`, requestIdToDelete));
            } catch (error) {
                console.error("Erro ao excluir solicitação: ", error);
                alert("Ocorreu um erro ao excluir a solicitação.");
            } finally {
                closeModal(deleteConfirmModal);
                requestIdToDelete = null;
            }
        }
        
        // --- EVENT LISTENERS ---
        if(menuButton) menuButton.addEventListener('click', toggleMenu);
        if(overlay) overlay.addEventListener('click', toggleMenu);
        
        tableBody.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (viewBtn) showViewModal(viewBtn.dataset.id);
            if (deleteBtn) { requestIdToDelete = deleteBtn.dataset.id; openModal(deleteConfirmModal); }
        });
        
        viewModal.addEventListener('click', (e) => { if (e.target === viewModal || e.target.closest('#close-view-modal-btn')) closeModal(viewModal); });
        cancelDeleteBtn.addEventListener('click', () => { closeModal(deleteConfirmModal); requestIdToDelete = null; });
        confirmDeleteBtn.addEventListener('click', deleteRequest);

        // --- FIREBASE INITIALIZATION & REALTIME LISTENERS ---
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'tfd-paraguacu-paulista-local';
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {
                        apiKey: "AIzaSyAWWhu2U6ZJ9AQYZ_Awa2CnciewwY2x71E",
                        authDomain: "tfd-transporte.firebaseapp.com",
                        projectId: "tfd-transporte",
                        storageBucket: "tfd-transporte.appspot.com",
                        messagingSenderId: "747365724187",
                        appId: "1:747365724187:web:4056286c794834f69f48be"
                      };
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                
                if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                const requestsCollection = collection(db, `artifacts/${appId}/public/data/travelRequests`);
                onSnapshot(requestsCollection, (snapshot) => {
                    allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTable();
                });

            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Não foi possível conectar à base de dados. Verifique a configuração do Firebase.</td></tr>';
            }
        }

        initializeFirebase();
    });
</script>
</body>
</html>

